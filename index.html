<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Ironclad Vault</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { background: #020617; color: #f8fafc; font-family: 'Space Grotesk', sans-serif; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .glass-header { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid #1e293b; padding-top: calc(1rem + var(--safe-top)); }
        
        #chat-box::-webkit-scrollbar { display: none; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; margin-bottom: 4px; animation: slideIn 0.2s ease-out; }
        .bubble-me { background: #6366f1; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bubble-them { background: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Static Underline Status */
        .status-line { width: 14px; height: 2px; border: 1px solid rgba(255,255,255,0.3); margin-top: 4px; display: none; }
        .status-line.delivered { display: block; }
        .status-line.seen { display: block; background: #fff; border-color: #fff; box-shadow: 0 0 8px #6366f1; }

        /* Timer Bar */
        .timer-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.2); overflow: hidden; border-radius: 0 0 20px 20px; }
        .timer-fill { height: 100%; background: #fff; width: 100%; transition: width linear; }

        .fx-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 100; overflow: hidden; }
        .explicit-gif { position: absolute; width: 150px; height: 150px; border-radius: 20px; object-fit: cover; animation: popUp 2s forwards; border: 2px solid #6366f1; }
        @keyframes popUp { 0% { transform: scale(0.5); opacity: 0; } 20% { opacity: 1; transform: scale(1.1); } 100% { transform: translateY(-100px); opacity: 0; } }
        
        #lock-screen { position: absolute; inset: 0; background: #020617; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <header class="glass-header p-5 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold tracking-widest text-indigo-500 italic">IRONCLAD</h1>
            <p id="display-id" class="text-[10px] text-zinc-500 font-bold uppercase"></p>
        </div>
        <button onclick="requestWipe()" class="p-3 rounded-xl bg-red-500/10 border border-red-500/30 text-red-500 active:scale-90">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        </button>
    </header>

    <main class="flex-1 relative overflow-hidden bg-[#010409]">
        <div id="lock-screen">
            <input id="key-input" type="password" placeholder="Access Key" class="bg-zinc-900 border border-zinc-800 text-center py-4 px-6 rounded-2xl mb-4 outline-none focus:border-indigo-500 transition-all">
            <button onclick="unlockVault()" class="bg-indigo-600 px-10 py-4 rounded-2xl font-bold uppercase text-xs tracking-widest">Unlock</button>
        </div>
        <div class="fx-overlay" id="fx-layer"></div>
        <div id="chat-box" class="h-full overflow-y-auto p-5 space-y-4 flex flex-col pb-20"></div>
    </main>

    <div id="wipe-modal" class="hidden fixed inset-0 bg-black/95 z-[300] flex items-center justify-center p-8 backdrop-blur-xl">
        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-[40px] w-full text-center">
            <h2 class="text-2xl font-bold text-red-500 mb-6 italic">PURGE SIGNAL</h2>
            <button onclick="performWipe()" class="w-full bg-red-600 py-5 rounded-2xl font-bold uppercase mb-4">Wipe & Reset ID</button>
            <button onclick="cancelWipe()" class="text-zinc-500 uppercase text-xs font-bold">Ignore</button>
        </div>
    </div>

    <div class="p-4 bg-zinc-950 border-t border-zinc-900">
        <div class="flex gap-2 mb-3 bg-white/5 rounded-2xl p-2 items-center">
            <input id="peer-id" type="number" placeholder="Partner ID" class="w-24 bg-transparent px-3 py-1 font-bold text-indigo-400 outline-none">
            <div class="flex-1"></div>
            <button id="sd-btn" onclick="toggleSD()" class="px-4 py-2 rounded-xl bg-zinc-800 text-[10px] font-bold border border-zinc-700 transition-all">TIMER OFF</button>
        </div>
        <div class="flex gap-3">
            <input id="msg-input" type="text" placeholder="Secret message..." class="flex-1 bg-zinc-900 rounded-2xl p-4 outline-none">
            <button onclick="sendMsg()" class="bg-indigo-600 w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/20"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
        </div>
    </div>

    <script>
        const config = { databaseURL: "https://atchat-at-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(config);
        const db = firebase.database();

        let vaultKey = "", sdOn = false;
        let myID = localStorage.getItem('v10_id') || Math.floor(10000 + Math.random() * 89999).toString();
        localStorage.setItem('v10_id', myID);

        function init() {
            document.getElementById('display-id').innerText = `Your ID: ${myID}`;
            db.ref('vault/' + myID).on('child_added', snap => {
                const data = snap.val();
                db.ref(`status/${data.sid}/${snap.key}`).set('reached');
                if(vaultKey) decryptAndShow(data.msg, false, snap.key, data.sd, data.ts);
                else saveToDisk(data.msg, false, snap.key, data.sd, data.ts);
            });
            db.ref('purges/' + myID).on('value', snap => {
                if(snap.val() === 'now') document.getElementById('wipe-modal').classList.remove('hidden');
                if(snap.val() === 'go') wipeAll();
            });
        }

        function unlockVault() {
            const val = document.getElementById('key-input').value;
            if(!val) return;
            vaultKey = val;
            document.getElementById('lock-screen').style.display = 'none';
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('v10_hist_' + myID) || '[]');
            history.forEach(m => decryptAndShow(m.blob, m.isMe, m.id, m.sd, m.ts));
        }

        function decryptAndShow(blob, isMe, msgId, sd, ts) {
            try {
                const bytes = CryptoJS.AES.decrypt(blob, vaultKey);
                const text = bytes.toString(CryptoJS.enc.Utf8);
                if(!text || document.getElementById('m-'+msgId)) return;

                if(!isMe) db.ref(`status/${localStorage.getItem('v10_p')}/${msgId}`).set('seen');

                const d = document.createElement('div');
                d.id = 'm-' + msgId;
                d.className = `bubble ${isMe ? 'bubble-me' : 'bubble-them'}`;
                
                let tPart = sd ? `<div class="timer-bg"><div id="f-${msgId}" class="timer-fill"></div></div>` : '';
                let sPart = isMe ? `<div class="flex justify-end"><div id="l-${msgId}" class="status-line"></div></div>` : '';
                
                d.innerHTML = `<div>${text}</div>${sPart}${tPart}`;
                document.getElementById('chat-box').appendChild(d);
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;

                if(!isMe) checkKeywords(text);

                if(sd) {
                    const elapsed = (Date.now() - ts) / 1000;
                    const rem = Math.max(0, 30 - elapsed);
                    const fill = document.getElementById(`f-${msgId}`);
                    setTimeout(() => { fill.style.transition = `width ${rem}s linear`; fill.style.width = '0%'; }, 50);
                    setTimeout(() => { 
                        d.remove(); 
                        removeFromDisk(msgId);
                        db.ref('vault/' + (isMe ? localStorage.getItem('v10_p') : myID)).child(msgId).remove();
                    }, rem * 1000);
                }

                if(isMe) {
                    db.ref(`status/${myID}/${msgId}`).on('value', s => {
                        const line = document.getElementById(`l-${msgId}`);
                        if(!line) return;
                        if(s.val() === 'reached') line.classList.add('delivered');
                        if(s.val() === 'seen') { line.classList.add('delivered'); line.classList.add('seen'); }
                    });
                }
            } catch(e) {}
        }

        function sendMsg() {
            const rid = document.getElementById('peer-id').value;
            const val = document.getElementById('msg-input').value.trim();
            if(!rid || !vaultKey || !val) return;
            localStorage.setItem('v10_p', rid);
            
            const enc = CryptoJS.AES.encrypt(val, vaultKey).toString();
            const mid = Date.now();
            db.ref('vault/' + rid + '/' + mid).set({ msg: enc, sid: myID, sd: sdOn, ts: mid });
            decryptAndShow(enc, true, mid, sdOn, mid);
            saveToDisk(enc, true, mid, sdOn, mid);
            document.getElementById('msg-input').value = "";
        }

        function checkKeywords(txt) {
            const t = txt.toLowerCase();
            const map = {
                "boobs": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3N5bmZ5Ynh6N3R4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/3o7TKVUn7iM8FMEU24/giphy.gif",
                "pussy": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNHR4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/l2SpVztQ0r25oM4hW/giphy.gif",
                "kiss": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNXR4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1n/l4FsKaMhGQFpqP2oM/giphy.gif"
            };
            for(let k in map) {
                if(t.includes(k)) {
                    const img = document.createElement('img');
                    img.src = map[k]; img.className = 'explicit-gif';
                    img.style.left = Math.random() * 50 + '%'; img.style.top = '40%';
                    document.getElementById('fx-layer').appendChild(img);
                    setTimeout(() => img.remove(), 2000);
                }
            }
        }

        function toggleSD() {
            sdOn = !sdOn;
            const btn = document.getElementById('sd-btn');
            btn.innerText = sdOn ? "TIMER ON" : "TIMER OFF";
            btn.style.borderColor = sdOn ? "#6366f1" : "#3f3f46";
            btn.style.color = sdOn ? "#818cf8" : "#a1a1aa";
        }

        function requestWipe() {
            const rid = document.getElementById('peer-id').value;
            if(rid) db.ref('purges/' + rid).set('now');
        }

        function performWipe() {
            const rid = document.getElementById('peer-id').value;
            db.ref('purges/' + rid).set('go');
            wipeAll();
        }

        function wipeAll() {
            db.ref('vault/' + myID).remove();
            db.ref('purges/' + myID).remove();
            localStorage.clear();
            location.reload();
        }

        function cancelWipe() { db.ref('purges/' + myID).remove(); document.getElementById('wipe-modal').classList.add('hidden'); }
        function saveToDisk(blob, isMe, id, sd, ts) {
            const h = JSON.parse(localStorage.getItem('v10_hist_' + myID) || '[]');
            h.push({blob, isMe, id, sd, ts});
            localStorage.setItem('v10_hist_' + myID, JSON.stringify(h));
        }
        function removeFromDisk(id) {
            const h = JSON.parse(localStorage.getItem('v10_hist_' + myID) || '[]');
            localStorage.setItem('v10_hist_' + myID, JSON.stringify(h.filter(m => m.id !== id)));
        }
        window.onload = init;
    </script>
</body>
</html>
