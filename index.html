<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ATchat Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <style>
        body { background: #000; color: #fff; font-family: 'Space Grotesk', sans-serif; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; margin-bottom: 8px; }
        #chat-box::-webkit-scrollbar { display: none; }
        .glass { background: rgba(20,20,20,0.9); backdrop-filter: blur(20px); border-top: 1px solid #333; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="p-6 border-b border-white/10 flex justify-between items-center">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">ATchat</h1>
        <div class="text-[10px] bg-emerald-500/10 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/20">LIVE PUSH</div>
    </header>

    <div id="chat-box" class="flex-1 overflow-y-auto p-4 flex flex-col"></div>

    <div class="glass p-6 pb-[calc(2rem+env(safe-area-inset-bottom))]">
        <div class="flex gap-2 mb-4">
            <input id="peer-id" type="text" placeholder="Recipient ID" class="flex-1 bg-white/5 rounded-xl p-3 text-sm outline-none border border-white/10 text-blue-400">
        </div>
        <div class="flex gap-3">
            <input id="msg-input" type="text" placeholder="Message..." class="flex-1 bg-white/5 rounded-2xl p-4 outline-none border border-white/5">
            <button onclick="sendMessage()" class="bg-blue-600 w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-900/40">
                <svg viewBox="0 0 24 24" class="w-6 h-6 fill-white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyBxe0NPT6W47NzuBCURCIykoh2PSVLLMr0",
            databaseURL: "https://atchat-at-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "atchat-at",
            messagingSenderId: "1075535307819",
            appId: "1:1075535307819:web:95baf0479d0a101c3bf66e"
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const messaging = firebase.messaging();
        let myID = localStorage.getItem('atchat_id') || Math.random().toString(36).substring(2, 9).toUpperCase();
        localStorage.setItem('atchat_id', myID);

        // Persistent Connection
        const savedPeer = localStorage.getItem('perm_peer');
        if(savedPeer) document.getElementById('peer-id').value = savedPeer;

        // Register Service Worker & Get Push Token
        navigator.serviceWorker.register('sw.js').then((reg) => {
            messaging.useServiceWorker(reg);
            messaging.getToken({ vapidKey: 'BDXb_HWYtqR5QPds_IHzrlDTmhmqSXvEc4r1-BXoDzT-nYnEwzihPgkDzlUJCjfA2GBfQZYeUq2xxRaMJvKEzSY' })
            .then(token => {
                if(token) db.ref('pushTokens/' + myID).set(token);
            });
        });

        // Load History
        const hist = JSON.parse(localStorage.getItem('chat_hist') || '[]');
        hist.forEach(m => addBubble(m.t, m.m));

        db.ref('inbox/' + myID).on('child_added', snap => {
            const data = snap.val();
            addBubble(data.msg, false);
            saveHist(data.msg, false);
        });

        function sendMessage() {
            const rid = document.getElementById('peer-id').value.trim();
            const msg = document.getElementById('msg-input').value.trim();
            if(!rid || !msg) return;

            localStorage.setItem('perm_peer', rid);
            db.ref('inbox/' + rid).push({ msg, sid: myID });
            
            addBubble(msg, true);
            saveHist(msg, true);
            document.getElementById('msg-input').value = "";
        }

        function addBubble(t, isMe) {
            const d = document.createElement('div');
            d.className = `bubble ${isMe ? 'bg-blue-600 self-end rounded-tr-none' : 'bg-zinc-800 self-start rounded-tl-none'}`;
            d.innerText = t;
            document.getElementById('chat-box').appendChild(d);
            window.scrollTo(0,document.body.scrollHeight);
        }

        function saveHist(t, m) {
            hist.push({t, m});
            localStorage.setItem('chat_hist', JSON.stringify(hist));
        }
    </script>
</body>
</html>
